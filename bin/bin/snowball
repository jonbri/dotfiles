#!/usr/bin/perl -w
# snowball - make fake git changes

use strict;

use Getopt::Long;

my $a_working;
my $a_index;
my $a_untracked;
my $a_conflict;
my $a_help;

sub help() {
    print STDERR <<'HELP';

snowball - make fake git changes

USAGE:
  >> snowball [options]

Options:
  --working   (-w) working directory dirty
  --index     (-i) cache (stage) dirty
  --untracked (-u) create untracked file
  --conflict  (-c) create merge conflict

EXAMPLES:
  >> snowball       # create fake commit
  >> snowball -w    # just dirty working dir
  >> snowball -i    # just dirty index
  >> snowball -u    # untracked

HELP
}

sub getFirstNonOptionArg {
    my $arg = shift @ARGV;
    if (!defined $arg) {
        return;
    }
    return ($arg =~ /^-/) ? getFirstNonOptionArg() : $arg;
}


sub runCommand($) {
    my ($command) = @_;
    open CMD, "$command |" || die "Unable to run $command: $!";
    my @output = <CMD>;
    close CMD;
    return @output;
}

MAIN: {
    GetOptions(
        'working' => \$a_working,
        'index' => \$a_index,
        'untracked' => \$a_untracked,
        'conflict' => \$a_conflict,
        'help' => \$a_help
    ) || (help() && exit 1);

    # show help if either arg or option is given
    my $firstArg=getFirstNonOptionArg();
    if (($firstArg && $firstArg eq "help") || defined $a_help) {
        help();
        exit 1;
    }

    my @trackedFiles = runCommand("git ls-tree -r master --name-only");
    my $EXISTING_FILE0 = $trackedFiles[0];
    chomp $EXISTING_FILE0;
    my $EXISTING_FILE1 = $trackedFiles[1];
    chomp $EXISTING_FILE1;
    my $EXISTING_FILE2 = $trackedFiles[2];
    chomp $EXISTING_FILE2;

    if (defined $a_working) {
        if (!defined $EXISTING_FILE0) {
            print "repo needs at least one tracked file\n";
            exit 1;
        }
        print `echo "snowball working" >> $EXISTING_FILE0`;
        exit 0;
    }

    if (defined $a_index) {
        if (!defined $EXISTING_FILE1) {
            print "repo needs at least two tracked files\n";
            exit 1;
        }
        print `echo "snowball index" >> $EXISTING_FILE1`;
        print `git add $EXISTING_FILE1`;
        exit 0;
    }

    if (defined $a_untracked) {
        my $random = int(rand(10000));
        print `echo "snowball" >> snowball_untracked_log$random.txt`;
        exit 0;
    }

    if (defined $a_conflict) {
        if (!defined $EXISTING_FILE2) {
            print "repo needs at least three tracked files\n";
            exit 1;
        }
        print "start --conflict\n";
        exit 0;
    }

    # default behavior: create commit
    print `echo "snowball" >> snowball_commit_log.txt`;
    print `git add snowball_commit_log.txt`;
    print `git commit -m 'snowball'`;

    exit 0;
}


