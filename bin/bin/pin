#!/bin/bash
# pin - git push origin `branch`

ARG=$1
BRANCH=`git rev-parse --abbrev-ref HEAD`;
GIT_NAME=`persona | firstline`;
GIT_EMAIL=`persona | lastline`;

KNOWN_RESULTS=`persona --known`
if [[ $KNOWN_RESULTS =~ "not found" ]]; then
  echo "WARNING: ${GIT_NAME}(${GIT_EMAIL}) NOT FOUND in this repo's history";
  read -p "continue? (press enter) " yn
fi

git fetch

if [[ `git status --porcelain` ]]; then
    echo "outstanding changes"
    git status --short
    read -p "amend? (press enter) " yn
    git add . && git commit --quiet --amend --reuse-message=HEAD
fi

if [ "$ARG" = "--yes" ] || [ "$ARG" = "-y" ]; then
    echo "skipping confirmation"
else
    if [ ! `git rev-parse --verify origin/$BRANCH 2>/dev/null` ]; then
        echo "origin/$BRANCH does not exist"
    else
        leftright
    fi

    read -p "git push --force origin $BRANCH (press enter) " yn
fi

crumb pin_$BRANCH
git push --force origin $BRANCH
echo "done"

